name: Build EasyTier-web

on:
  workflow_dispatch:  # 允许手动触发

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmmirror.com'  # 使用淘宝镜像

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Cache Rust Dependencies
      uses: Swatinem/rust-cache@v2

    - name: Install Linux Dependencies
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev

    - name: Build Frontend
      working-directory: ./easytier-web/frontend
      run: |
        npm config set registry https://registry.npmmirror.com  # 设置 npm 镜像
        npm install --legacy-peer-deps  # 添加 --legacy-peer-deps 参数
        npm run build
      env:
        NODE_OPTIONS: "--max-old-space-size=4096"  # 增加 Node.js 内存限制

    - name: Build Backend
      working-directory: ./easytier-web
      run: |
        cargo build --release
      env:
        RUSTFLAGS: "-C target-feature=+crt-static"

    - name: Package Windows Build
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release
        Copy-Item "easytier-web\target\release\easytier-web.exe" -Destination "release\"
        Compress-Archive -Path "release\*" -DestinationPath "easytier-web-windows.zip"

    - name: Package Linux Build
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p release
        cp easytier-web/target/release/easytier-web release/
        tar -czf easytier-web-linux.tar.gz release/

    - name: Upload Windows Artifact
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: easytier-web-windows
        path: easytier-web-windows.zip
        retention-days: 5

    - name: Upload Linux Artifact
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: easytier-web-linux
        path: easytier-web-linux.tar.gz
        retention-days: 5
