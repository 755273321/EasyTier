name: Build EasyTier-web

on:
  workflow_dispatch:  # 允许手动触发

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-C target-feature=+crt-static"

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest]  # 只保留 ubuntu
      fail-fast: false
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'  # 确保获取所有子模块

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-unknown-linux-gnu  # 只保留 Linux target

    - name: Install Linux Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev build-essential

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build Frontend-lib
      working-directory: ./easytier-web/frontend-lib
      run: |
        pnpm install
        pnpm build

    - name: Build Frontend
      working-directory: ./easytier-web/frontend
      run: |
        pnpm install
        pnpm build

    - name: Build Backend
      working-directory: ./easytier-web
      run: |
        cargo build --release

    - name: Package Build
      working-directory: ./easytier-web
      run: |
        mkdir -p release
        cp target/release/easytier-web release/
        cp -r frontend/dist release/
        tar -czf easytier-web-linux.tar.gz release/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: easytier-web-linux
        path: easytier-web/easytier-web-linux.tar.gz
        retention-days: 5
